name: Auto Translate Documents

on:
  # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: ['main']
    paths:
      # ä¸­æ–‡æ–‡æ¡£å˜æ›´æ—¶è§¦å‘
      - 'content/docs/zh/**/*.md'
      - 'content/docs/zh/**/*.mdx'
      # ç¿»è¯‘æ–‡ä»¶è¢«åˆ é™¤æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºè‡ªåŠ¨è¡¥å…¨ï¼‰
      - 'content/docs/en/**/*.md'
      - 'content/docs/en/**/*.mdx'
      - 'content/docs/ja/**/*.md'
      - 'content/docs/ja/**/*.mdx'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'ç¿»è¯‘æ¨¡å¼ / Translation Mode'
        required: true
        type: choice
        default: 'changed'
        options:
          - changed # åªç¿»è¯‘å˜æ›´çš„æ–‡ä»¶
          - force_all # å¼ºåˆ¶é‡æ–°ç¿»è¯‘æ‰€æœ‰æ–‡ä»¶
          - missing_only # åªç¿»è¯‘ç¼ºå¤±çš„æ–‡ä»¶
          - specific_path # ç¿»è¯‘æŒ‡å®šè·¯å¾„
      path:
        description: 'æŒ‡å®šè·¯å¾„ / Specific Path (æ–‡ä»¶å¤¹å¦‚: api, å•ä¸ªæ–‡ä»¶å¦‚: api/ai-model/list-models/list-models.mdx)'
        required: false
        type: string
        default: ''

# è®¾ç½®æƒé™
permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # è·å–æœ€è¿‘2æ¬¡æäº¤ï¼Œç”¨äºæ£€æµ‹æ‰‹åŠ¨ç¿»è¯‘

      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ” Get changed files
        id: changed-files
        run: |
          MODE="${{ github.event.inputs.mode }}"

          # å¦‚æœæ˜¯ push è§¦å‘ï¼Œé»˜è®¤ä¸º changed æ¨¡å¼
          if [ -z "$MODE" ]; then
            MODE="changed"
          fi

          echo "ğŸ“‹ ç¿»è¯‘æ¨¡å¼: $MODE"

          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨æ–‡ä»¶åˆ—è¡¨ï¼ˆé¿å…è·¯å¾„ä¸­ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
          FILES_LIST=$(mktemp)

          if [ "$MODE" = "force_all" ]; then
            # å¼ºåˆ¶ç¿»è¯‘æ‰€æœ‰æ–‡æ¡£
            echo "ğŸ“š è·å–æ‰€æœ‰ä¸­æ–‡æ–‡æ¡£æ–‡ä»¶..."
            find content/docs/zh -name "*.md" -o -name "*.mdx" > "$FILES_LIST"

          elif [ "$MODE" = "specific_path" ]; then
            # ç¿»è¯‘æŒ‡å®šè·¯å¾„
            SPECIFIC_PATH="${{ github.event.inputs.path }}"
            if [ -z "$SPECIFIC_PATH" ]; then
              echo "âŒ é”™è¯¯: specific_path æ¨¡å¼éœ€è¦æŒ‡å®šè·¯å¾„"
              exit 1
            fi
            
            # æ„å»ºå®Œæ•´è·¯å¾„
            FULL_PATH="content/docs/zh/$SPECIFIC_PATH"
            
            if [ ! -e "$FULL_PATH" ]; then
              echo "âŒ é”™è¯¯: è·¯å¾„ä¸å­˜åœ¨: $FULL_PATH"
              exit 1
            fi
            
            echo "ğŸ“ ç¿»è¯‘æŒ‡å®šè·¯å¾„: $FULL_PATH"
            
            if [ -d "$FULL_PATH" ]; then
              # æ˜¯ç›®å½•ï¼Œæ”¶é›†æ‰€æœ‰ markdown æ–‡ä»¶
              find "$FULL_PATH" \( -name "*.md" -o -name "*.mdx" \) > "$FILES_LIST"
            else
              # æ˜¯æ–‡ä»¶
              echo "$FULL_PATH" > "$FILES_LIST"
            fi
            
          elif [ "$MODE" = "missing_only" ]; then
            # åªç¿»è¯‘ç¼ºå¤±çš„æ–‡æ¡£
            echo "ğŸ” æ£€æµ‹ç¼ºå¤±çš„ç¿»è¯‘æ–‡ä»¶..."
            
            # éå†æ‰€æœ‰ä¸­æ–‡æ–‡æ¡£ï¼ˆä½¿ç”¨ -print0 å’Œ read å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
            while IFS= read -r -d '' zh_file; do
              # è®¡ç®—ç›¸å¯¹è·¯å¾„
              rel_path="${zh_file#content/docs/zh/}"
              
              # æ£€æŸ¥è‹±æ–‡å’Œæ—¥æ–‡ç¿»è¯‘æ˜¯å¦å­˜åœ¨
              en_file="content/docs/en/$rel_path"
              ja_file="content/docs/ja/$rel_path"
              
              if [ ! -f "$en_file" ] || [ ! -f "$ja_file" ]; then
                echo "$zh_file" >> "$FILES_LIST"
                if [ ! -f "$en_file" ]; then
                  echo "  âŒ ç¼ºå¤±è‹±æ–‡ç¿»è¯‘: $en_file"
                fi
                if [ ! -f "$ja_file" ]; then
                  echo "  âŒ ç¼ºå¤±æ—¥æ–‡ç¿»è¯‘: $ja_file"
                fi
              fi
            done < <(find content/docs/zh \( -name "*.md" -o -name "*.mdx" \) -print0)
            
          else
            # æ­£å¸¸æ¨¡å¼ï¼šæ£€æµ‹å˜æ›´å’Œç¼ºå¤±
            echo "ğŸ“ æ£€æµ‹å˜æ›´å’Œç¼ºå¤±çš„ç¿»è¯‘..."
            
            # 1. è·å–å˜æ›´çš„ä¸­æ–‡æ–‡æ¡£
            git diff --name-only HEAD~1 HEAD | grep -E '^content/docs/zh/.*\.(md|mdx)$' >> "$FILES_LIST" || true
            
            # 2. è·å–è¢«åˆ é™¤çš„ç¿»è¯‘æ–‡ä»¶å¯¹åº”çš„ä¸­æ–‡æºæ–‡ä»¶
            DELETED_TRANSLATIONS=$(git diff --name-only HEAD~1 HEAD | grep -E '^content/docs/(en|ja)/.*\.(md|mdx)$' || echo "")
            
            if [ ! -z "$DELETED_TRANSLATIONS" ]; then
              echo "ğŸ—‘ï¸ æ£€æµ‹åˆ°ç¿»è¯‘æ–‡ä»¶è¢«åˆ é™¤:"
              echo "$DELETED_TRANSLATIONS" | while IFS= read -r trans_file; do
                [ -z "$trans_file" ] && continue
                echo "  - $trans_file"
                # æå–ç›¸å¯¹è·¯å¾„
                if [[ "$trans_file" == content/docs/en/* ]]; then
                  rel_path="${trans_file#content/docs/en/}"
                elif [[ "$trans_file" == content/docs/ja/* ]]; then
                  rel_path="${trans_file#content/docs/ja/}"
                fi
                
                # æ„å»ºå¯¹åº”çš„ä¸­æ–‡æºæ–‡ä»¶è·¯å¾„
                zh_file="content/docs/zh/$rel_path"
                
                # å¦‚æœä¸­æ–‡æºæ–‡ä»¶å­˜åœ¨ï¼Œæ·»åŠ åˆ°å¾…ç¿»è¯‘åˆ—è¡¨
                if [ -f "$zh_file" ]; then
                  echo "$zh_file" >> "$FILES_LIST"
                  echo "  âœ“ æ‰¾åˆ°å¯¹åº”çš„ä¸­æ–‡æºæ–‡ä»¶: $zh_file"
                fi
              done
            fi
            
            # å»é‡
            sort -u "$FILES_LIST" -o "$FILES_LIST"
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦ç¿»è¯‘
          if [ ! -s "$FILES_LIST" ]; then
            echo "âœ… æ²¡æœ‰éœ€è¦ç¿»è¯‘çš„æ–‡æ¡£æ–‡ä»¶"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            rm -f "$FILES_LIST"
          else
            echo "ğŸ“Š å¾…ç¿»è¯‘æ–‡ä»¶:"
            cat "$FILES_LIST"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # ä¿å­˜æ–‡ä»¶åˆ—è¡¨è·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            cp "$FILES_LIST" /tmp/translate_files.txt
            rm -f "$FILES_LIST"
          fi

      - name: ğŸŒ Translate documents
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          MODE="${{ github.event.inputs.mode }}"
          IS_PUSH="${{ github.event_name == 'push' }}"

          # è¯»å–æ–‡ä»¶åˆ—è¡¨å¹¶ç”¨ xargs æ­£ç¡®å¤„ç†ç‰¹æ®Šå­—ç¬¦
          if [ "$MODE" = "force_all" ]; then
            echo "ğŸ”„ å¼ºåˆ¶é‡æ–°ç¿»è¯‘æ‰€æœ‰æ–‡ä»¶..."
            FORCE_TRANSLATE=true xargs -d '\n' bun run translate < /tmp/translate_files.txt
          elif [ "$MODE" = "specific_path" ]; then
            echo "ğŸ“ ç¿»è¯‘æŒ‡å®šè·¯å¾„: ${{ github.event.inputs.path }}"
            FORCE_TRANSLATE=true xargs -d '\n' bun run translate < /tmp/translate_files.txt
          elif [ "$IS_PUSH" = "true" ]; then
            echo "ğŸŒ ç¿»è¯‘æ–‡ä»¶ï¼ˆpush è§¦å‘ï¼Œå¼ºåˆ¶æ¨¡å¼ï¼‰..."
            FORCE_TRANSLATE=true xargs -d '\n' bun run translate < /tmp/translate_files.txt
          else
            echo "ğŸŒ ç¿»è¯‘æ–‡ä»¶..."
            xargs -d '\n' bun run translate < /tmp/translate_files.txt
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gemini-2.5-flash' }}
          MAX_RETRIES: ${{ secrets.MAX_RETRIES || '3' }}
          RETRY_DELAY: ${{ secrets.RETRY_DELAY || '2' }}
          RETRY_BACKOFF: ${{ secrets.RETRY_BACKOFF || '2.0' }}
          MAX_WORKERS: ${{ secrets.MAX_WORKERS || '3' }}

      - name: ğŸ“ Create Pull Request
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸŒ docs: auto-translate documents

            Generated by GitHub Actions workflow
          branch: auto-translate-${{ github.run_id }}
          delete-branch: true
          title: 'ğŸŒ Auto-translate documentation'
          body: |
            ## ğŸ“ Auto Translation

            **Trigger**: ${{ github.event_name }}  
            **Mode**: ${{ github.event.inputs.mode || 'changed' }}  
            **Workflow**: [#${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            See workflow run for translated files list.
          labels: |
            documentation
            auto-translation
          assignees: ${{ github.actor }}

      - name: ğŸ“Š Summary
        if: always()
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" = "true" ]; then
            echo "### ğŸŒ Translation Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changed files:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            if [ -f /tmp/translate_files.txt ]; then
              cat /tmp/translate_files.txt >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Translation completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Translation Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No Chinese documents were changed in this commit." >> $GITHUB_STEP_SUMMARY
          fi
