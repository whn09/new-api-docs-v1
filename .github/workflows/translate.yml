name: Auto Translate Documents

on:
  # å½“æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: ['main']
    paths:
      # ä¸­æ–‡æ–‡æ¡£å˜æ›´æ—¶è§¦å‘
      - 'content/docs/zh/**/*.md'
      - 'content/docs/zh/**/*.mdx'
      # ç¿»è¯‘æ–‡ä»¶è¢«åˆ é™¤æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºŽè‡ªåŠ¨è¡¥å…¨ï¼‰
      - 'content/docs/en/**/*.md'
      - 'content/docs/en/**/*.mdx'
      - 'content/docs/ja/**/*.md'
      - 'content/docs/ja/**/*.mdx'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'ç¿»è¯‘æ¨¡å¼ / Translation Mode'
        required: true
        type: choice
        default: 'changed'
        options:
          - changed # åªç¿»è¯‘å˜æ›´çš„æ–‡ä»¶
          - force_all # å¼ºåˆ¶é‡æ–°ç¿»è¯‘æ‰€æœ‰æ–‡ä»¶
          - missing_only # åªç¿»è¯‘ç¼ºå¤±çš„æ–‡ä»¶

# è®¾ç½®æƒé™
permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # èŽ·å–æœ€è¿‘2æ¬¡æäº¤ï¼Œç”¨äºŽæ£€æµ‹æ‰‹åŠ¨ç¿»è¯‘

      - name: ðŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ” Get changed files
        id: changed-files
        run: |
          MODE="${{ github.event.inputs.mode }}"

          # å¦‚æžœæ˜¯ push è§¦å‘ï¼Œé»˜è®¤ä¸º changed æ¨¡å¼
          if [ -z "$MODE" ]; then
            MODE="changed"
          fi

          echo "ðŸ“‹ ç¿»è¯‘æ¨¡å¼: $MODE"

          if [ "$MODE" = "force_all" ]; then
            # å¼ºåˆ¶ç¿»è¯‘æ‰€æœ‰æ–‡æ¡£
            echo "ðŸ“š èŽ·å–æ‰€æœ‰ä¸­æ–‡æ–‡æ¡£æ–‡ä»¶..."
            CHANGED_FILES=$(find content/docs/zh -name "*.md" -o -name "*.mdx" | tr '\n' ' ')
            
          elif [ "$MODE" = "missing_only" ]; then
            # åªç¿»è¯‘ç¼ºå¤±çš„æ–‡æ¡£
            echo "ðŸ” æ£€æµ‹ç¼ºå¤±çš„ç¿»è¯‘æ–‡ä»¶..."
            CHANGED_FILES=""
            
            # éåŽ†æ‰€æœ‰ä¸­æ–‡æ–‡æ¡£
            for zh_file in $(find content/docs/zh -name "*.md" -o -name "*.mdx"); do
              # è®¡ç®—ç›¸å¯¹è·¯å¾„
              rel_path=${zh_file#content/docs/zh/}
              
              # æ£€æŸ¥è‹±æ–‡å’Œæ—¥æ–‡ç¿»è¯‘æ˜¯å¦å­˜åœ¨
              en_file="content/docs/en/$rel_path"
              ja_file="content/docs/ja/$rel_path"
              
              if [ ! -f "$en_file" ] || [ ! -f "$ja_file" ]; then
                CHANGED_FILES="$CHANGED_FILES $zh_file"
                if [ ! -f "$en_file" ]; then
                  echo "  âŒ ç¼ºå¤±è‹±æ–‡ç¿»è¯‘: $en_file"
                fi
                if [ ! -f "$ja_file" ]; then
                  echo "  âŒ ç¼ºå¤±æ—¥æ–‡ç¿»è¯‘: $ja_file"
                fi
              fi
            done
            
          else
            # æ­£å¸¸æ¨¡å¼ï¼šæ£€æµ‹å˜æ›´å’Œç¼ºå¤±
            echo "ðŸ“ æ£€æµ‹å˜æ›´å’Œç¼ºå¤±çš„ç¿»è¯‘..."
            
            # 1. èŽ·å–å˜æ›´çš„ä¸­æ–‡æ–‡æ¡£
            ZH_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '^content/docs/zh/.*\.(md|mdx)$' || echo "")
            
            # 2. èŽ·å–è¢«åˆ é™¤çš„ç¿»è¯‘æ–‡ä»¶å¯¹åº”çš„ä¸­æ–‡æºæ–‡ä»¶
            DELETED_TRANSLATIONS=$(git diff --name-only HEAD~1 HEAD | grep -E '^content/docs/(en|ja)/.*\.(md|mdx)$' || echo "")
            ZH_FROM_DELETED=""
            
            if [ ! -z "$DELETED_TRANSLATIONS" ]; then
              echo "ðŸ—‘ï¸ æ£€æµ‹åˆ°ç¿»è¯‘æ–‡ä»¶è¢«åˆ é™¤:"
              for trans_file in $DELETED_TRANSLATIONS; do
                echo "  - $trans_file"
                # æå–ç›¸å¯¹è·¯å¾„
                if [[ $trans_file == content/docs/en/* ]]; then
                  rel_path=${trans_file#content/docs/en/}
                elif [[ $trans_file == content/docs/ja/* ]]; then
                  rel_path=${trans_file#content/docs/ja/}
                fi
                
                # æž„å»ºå¯¹åº”çš„ä¸­æ–‡æºæ–‡ä»¶è·¯å¾„
                zh_file="content/docs/zh/$rel_path"
                
                # å¦‚æžœä¸­æ–‡æºæ–‡ä»¶å­˜åœ¨ï¼Œæ·»åŠ åˆ°å¾…ç¿»è¯‘åˆ—è¡¨
                if [ -f "$zh_file" ]; then
                  ZH_FROM_DELETED="$ZH_FROM_DELETED $zh_file"
                  echo "  âœ“ æ‰¾åˆ°å¯¹åº”çš„ä¸­æ–‡æºæ–‡ä»¶: $zh_file"
                fi
              done
            fi
            
            # åˆå¹¶ä¸¤ä¸ªåˆ—è¡¨å¹¶åŽ»é‡
            CHANGED_FILES=$(echo "$ZH_CHANGED $ZH_FROM_DELETED" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "âœ… æ²¡æœ‰éœ€è¦ç¿»è¯‘çš„æ–‡æ¡£æ–‡ä»¶"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“Š å¾…ç¿»è¯‘æ–‡ä»¶:"
            echo "$CHANGED_FILES" | tr ' ' '\n'
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # å°†æ–‡ä»¶åˆ—è¡¨ä¿å­˜ä¸ºå•è¡Œï¼Œç”¨ç©ºæ ¼åˆ†éš”
            echo "files=$(echo $CHANGED_FILES | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi

      - name: ðŸŒ Translate documents
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          MODE="${{ github.event.inputs.mode }}"
          IS_PUSH="${{ github.event_name == 'push' }}"

          if [ "$MODE" = "force_all" ]; then
            echo "ðŸ”„ å¼ºåˆ¶é‡æ–°ç¿»è¯‘æ‰€æœ‰æ–‡ä»¶..."
            FORCE_TRANSLATE=true bun run translate ${{ steps.changed-files.outputs.files }}
          elif [ "$IS_PUSH" = "true" ]; then
            echo "ðŸŒ ç¿»è¯‘æ–‡ä»¶ï¼ˆpush è§¦å‘ï¼Œå¼ºåˆ¶æ¨¡å¼ï¼‰..."
            FORCE_TRANSLATE=true bun run translate ${{ steps.changed-files.outputs.files }}
          else
            echo "ðŸŒ ç¿»è¯‘æ–‡ä»¶..."
            bun run translate ${{ steps.changed-files.outputs.files }}
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-mini' }}
          MAX_RETRIES: ${{ secrets.MAX_RETRIES || '3' }}
          RETRY_DELAY: ${{ secrets.RETRY_DELAY || '2' }}
          RETRY_BACKOFF: ${{ secrets.RETRY_BACKOFF || '2.0' }}
          MAX_WORKERS: ${{ secrets.MAX_WORKERS || '3' }}

      - name: ðŸ“ Create Pull Request
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸŒ docs: auto-translate documents

            Automatically translated the following files:
            ${{ steps.changed-files.outputs.files }}

            Generated by GitHub Actions workflow
          branch: auto-translate-${{ github.run_id }}
          delete-branch: true
          title: 'ðŸŒ Auto-translate documentation'
          body: |
            ## ðŸ“ è‡ªåŠ¨ç¿»è¯‘

            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼ŒåŒ…å«æ–‡æ¡£çš„è‡ªåŠ¨ç¿»è¯‘ã€‚

            ### ðŸ“Š ç¿»è¯‘ä¿¡æ¯
            - **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
            - **ç¿»è¯‘æ¨¡å¼**: ${{ github.event.inputs.mode || 'changed' }}
            - **å·¥ä½œæµè¿è¡Œ**: #${{ github.run_id }}

            ### ðŸ“ ç¿»è¯‘æ–‡ä»¶
            ```
            ${{ steps.changed-files.outputs.files }}
            ```

            ### âœ… æ£€æŸ¥é¡¹
            - [ ] ç¿»è¯‘å†…å®¹å‡†ç¡®
            - [ ] æ ¼å¼ä¿æŒå®Œæ•´
            - [ ] é“¾æŽ¥æ­£å¸¸å·¥ä½œ

            ---
            *Generated by [Auto Translate Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          labels: |
            documentation
            auto-translation
          assignees: ${{ github.actor }}

      - name: ðŸ“Š Summary
        if: always()
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" = "true" ]; then
            echo "### ðŸŒ Translation Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changed files:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.changed-files.outputs.files }}" | tr ' ' '\n' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Translation completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Translation Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No Chinese documents were changed in this commit." >> $GITHUB_STEP_SUMMARY
          fi
